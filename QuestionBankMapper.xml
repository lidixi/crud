<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dyzc.survey.mapper.QuestionBankMapper">

    <!-- 插入新题目 -->
    <insert id="insertQuestion">
        INSERT INTO t_question (qu_id, qu_name, qu_type, qu_create_date, order_by_id, qu_bank_name, qu_bank_code, qu_description)
        VALUES (
                   #{quId},
                   #{quName},
                   #{quType},
                   sysdate,
                   (SELECT COALESCE(MAX(order_by_id), 0) + 1 FROM t_question WHERE qu_bank_code = #{quBankCode}),
                   #{quBankName},
                   #{quBankCode},
                   #{quDescription}
               )
    </insert>

    <!-- 插入题目选项 -->
    <insert id="insertRadioOption">
        INSERT INTO t_qu_radio (radio_id, belong_qu_id, option_name, radio_order_by_id)
        VALUES (
                   #{radioId},
                   #{belongQuId},
                   #{optionName},
                   (SELECT COALESCE(MAX(radio_order_by_id), 0) + 1 FROM t_qu_radio WHERE belong_qu_id = #{belongQuId})
               )
    </insert>

    <insert id="insertCheckOption">
        INSERT INTO t_qu_checkbox (id, qu_id, option_name, order_by_id)
        VALUES (
                   #{id},
                   #{quId},
                   #{optionName},
                   (SELECT COALESCE(MAX(order_by_id), 0) + 1 FROM t_qu_checkbox WHERE qu_id = #{quId})
               )
    </insert>

    <insert id="insertMultiFillBlankOption">
        INSERT INTO t_qu_multi_fillblank (multi_fillblank_qu_id, qu_id, option_name, order_by_id)
        VALUES (
                   #{multiFillBlankQuId},
                   #{quId},
                   #{optionName},
                   (SELECT COALESCE(MAX(order_by_id), 0) + 1 FROM t_qu_multi_fillblank WHERE qu_id = #{quId})
               )
    </insert>

    <insert id="insertScoreOption">
        INSERT INTO t_qu_score (score_qu_id, qu_id, option_name, order_by_id)
        VALUES (
                   #{scoreQuId},
                   #{quId},
                   #{optionName},
                   (SELECT COALESCE(MAX(order_by_id), 0) + 1 FROM t_qu_score WHERE qu_id = #{quId})
               )
    </insert>

    <!-- 删除题目 -->
    <delete id="deleteQuestion">
        DELETE FROM t_question WHERE qu_id = #{quId}
    </delete>

    <!-- 删除题目选项 -->
    <delete id="deleteRadioOptionsByQuestionId">
        DELETE FROM t_qu_radio WHERE belong_qu_id = #{quId}
    </delete>

    <delete id="deleteCheckOptionsByQuestionId">
        DELETE FROM t_qu_checkbox WHERE qu_id = #{quId}
    </delete>

    <delete id="deleteMultiFillBlankOptionsByQuestionId">
        DELETE FROM t_qu_multi_fillblank WHERE qu_id = #{quId}
    </delete>

    <delete id="deleteScoreOptionsByQuestionId">
        DELETE FROM t_qu_score WHERE qu_id = #{quId}
    </delete>

    <!-- 更新排序 -->
    <update id="updateOrderByIdAfterDeletion">
        UPDATE t_question
        SET order_by_id = order_by_id - 1
        WHERE qu_bank_code = #{belongId} AND order_by_id > #{orderById}
    </update>

    <!-- 删除单个选项 -->
    <delete id="deleteRadioOption">
        DELETE FROM t_qu_radio WHERE radio_id = #{radioId}
    </delete>

    <delete id="deleteCheckOption">
        DELETE FROM t_qu_checkbox WHERE id = #{id}
    </delete>

    <delete id="deleteMultiFillBlankOption">
        DELETE FROM t_qu_multi_fillblank WHERE multi_fillblank_qu_id = #{multiFillBlankQuId}
    </delete>

    <delete id="deleteScoreOption">
        DELETE FROM t_qu_score WHERE score_qu_id = #{scoreQuId}
    </delete>

    <!-- 更新题目 -->
    <update id="updateQuestionByNameAndDescription">
        UPDATE t_question
        SET qu_name = #{quName},
            qu_description = #{quDescription},
            qu_create_date = sysdate
        WHERE qu_id = #{quId}
    </update>

    <!-- 更新选项 -->
    <update id="updateRadioOption">
        UPDATE t_qu_radio
        SET option_name = #{optionName}
        WHERE radio_id = #{radioId}
    </update>

    <update id="updateCheckOption">
        UPDATE t_qu_checkbox
        SET option_name = #{optionName}
        WHERE id = #{id}
    </update>

    <update id="updateMultiFillBlankOption">
        UPDATE t_qu_multi_fillblank
        SET option_name = #{optionName}
        WHERE multi_fillblank_qu_id = #{multiFillBlankQuId}
    </update>

    <update id="updateScoreOption">
        UPDATE t_qu_score
        SET option_name = #{optionName}
        WHERE score_qu_id = #{scoreQuId}
    </update>

    <!-- 查询题目和选项 -->
    <select id="selectQuestionsByBankCode" resultType="com.dyzc.survey.domain.QuestionBankModel">
        SELECT * FROM t_question WHERE qu_bank_code = #{quBankCode}
    </select>

    <select id="selectRadioOptionsByQuestionId" resultType="com.dyzc.survey.domain.RadioQuestionModel">
        SELECT * FROM t_qu_radio WHERE belong_qu_id = #{quId}
    </select>

    <select id="selectCheckOptionsByQuestionId" resultType="com.dyzc.survey.domain.CheckQuestionModel">
        SELECT * FROM t_qu_checkbox WHERE qu_id = #{quId}
    </select>

    <select id="selectMultiFillBlankOptionsByQuestionId" resultType="com.dyzc.survey.domain.MultiFillBlankQuestionModel">
        SELECT * FROM t_qu_multi_fillblank WHERE qu_id = #{quId}
    </select>

    <select id="selectScoreOptionsByQuestionId" resultType="com.dyzc.survey.domain.ScoreQuestionModel">
        SELECT * FROM t_qu_score WHERE qu_id = #{quId}
    </select>

    <!-- 模糊搜索题目 -->
    <select id="searchQuestions" resultType="com.dyzc.survey.domain.QuestionBankModel">
        SELECT * FROM t_question
        WHERE qu_bank_code = #{quBankCode}
          AND (qu_name LIKE CONCAT('%', #{quName}, '%') OR qu_description LIKE CONCAT('%', #{quDescription}, '%'))
    </select>

    <!-- 统计题目数量 -->
    <select id="countQuestionsByBankCode" resultType="int">
        SELECT COUNT(*) FROM t_question WHERE qu_bank_code = #{quBankCode}
    </select>

    <!-- 获取排序信息 -->
    <select id="getMaxOrderByIdByQuBankCode" resultType="int">
        SELECT COALESCE(MAX(order_by_id), 0)
        FROM t_question
        WHERE qu_bank_code = #{quBankCode}
    </select>

    <select id="getOrderByIdByQuId" resultType="int">
        SELECT order_by_id
        FROM t_question
        WHERE qu_id = #{quId}
    </select>

    <select id="getMaxRadioOrderById" resultType="int">
        SELECT COALESCE(MAX(radio_order_by_id), 0)
        FROM t_qu_radio
        WHERE belong_qu_id = #{quId}
    </select>

    <select id="getMaxCheckOrderById" resultType="int">
        SELECT COALESCE(MAX(order_by_id), 0)
        FROM t_qu_checkbox
        WHERE qu_id = #{quId}
    </select>

    <select id="getMaxMultiFillBlankOrderById" resultType="int">
        SELECT COALESCE(MAX(order_by_id), 0)
        FROM t_qu_multi_fillblank
        WHERE qu_id = #{quId}
    </select>

    <select id="getMaxScoreOrderById" resultType="int">
        SELECT COALESCE(MAX(order_by_id), 0)
        FROM t_qu_score
        WHERE qu_id = #{quId}
    </select>

    <!-- 获取选项的排序 -->
    <select id="getRadioOrderByIdByOptionId" resultType="int">
        SELECT radio_order_by_id
        FROM t_qu_radio
        WHERE radio_id = #{optionId}
    </select>

    <select id="getCheckOrderByIdByOptionId" resultType="int">
        SELECT order_by_id
        FROM t_qu_checkbox
        WHERE id = #{optionId}
    </select>

    <select id="getMultiFillBlankOrderByIdByOptionId" resultType="int">
        SELECT order_by_id
        FROM t_qu_multi_fillblank
        WHERE multi_fillblank_qu_id = #{optionId}
    </select>

    <select id="getScoreOrderByIdByOptionId" resultType="int">
        SELECT order_by_id
        FROM t_qu_score
        WHERE score_qu_id = #{optionId}
    </select>

    <!-- 更新选项排序 -->
    <update id="updateRadioOptionOrderByIdAfterDeletion">
        UPDATE t_qu_radio
        SET radio_order_by_id = radio_order_by_id - 1
        WHERE belong_qu_id = #{belongQuId} AND radio_order_by_id > #{orderById}
    </update>

    <update id="updateCheckOptionOrderByIdAfterDeletion">
        UPDATE t_qu_checkbox
        SET order_by_id = order_by_id - 1
        WHERE qu_id = #{quId} AND order_by_id > #{orderById}
    </update>

    <update id="updateMultiFillBlankOptionOrderByIdAfterDeletion">
        UPDATE t_qu_multi_fillblank
        SET order_by_id = order_by_id - 1
        WHERE qu_id = #{quId} AND order_by_id > #{orderById}
    </update>

    <update id="updateScoreOptionOrderByIdAfterDeletion">
        UPDATE t_qu_score
        SET order_by_id = order_by_id - 1
        WHERE qu_id = #{quId} AND order_by_id > #{orderById}
    </update>

    <!-- 获取题库信息 -->
    <select id="getQuBankCodeByQuId" resultType="String">
        SELECT qu_bank_code
        FROM t_question
        WHERE qu_id = #{quId}
    </select>

    <select id="getQuestionTypeByQuId" resultType="String">
        SELECT qu_type
        FROM t_question
        WHERE qu_id = #{quId}
    </select>

    <!-- 获取选项对应的题目ID -->
    <select id="getQuestionIdByOptionId" resultType="String">
        SELECT qu_id FROM (
                              SELECT belong_qu_id AS qu_id FROM t_qu_radio WHERE radio_id = #{optionId}
                              UNION ALL
                              SELECT qu_id FROM t_qu_checkbox WHERE id = #{optionId}
                              UNION ALL
                              SELECT qu_id FROM t_qu_multi_fillblank WHERE multi_fillblank_qu_id = #{optionId}
                              UNION ALL
                              SELECT qu_id FROM t_qu_score WHERE score_qu_id = #{optionId}
                          ) WHERE ROWNUM = 1
    </select>

</mapper>